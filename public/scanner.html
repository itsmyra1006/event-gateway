<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Gateway - Scanner</title>
    <style>
        :root { --bg-color: #f0f2f5; --container-bg: white; --text-color: #333; --input-border: #ddd; --shadow-color: rgba(0, 0, 0, 0.1); --primary-btn-bg: #007bff; --primary-btn-hover: #0056b3; --success-bg: #d4edda; --success-text: #155724; --error-bg: #f8d7da; --error-text: #721c24; --info-bg: #fff3cd; --info-text: #856404; }
        body.dark-theme { --bg-color: #1a1a1a; --container-bg: #2c2c2c; --text-color: #e0e0e0; --input-border: #555; --shadow-color: rgba(0, 0, 0, 0.4); --primary-btn-bg: #0056b3; --primary-btn-hover: #004494; --success-bg: #155724; --success-text: #d4edda; --error-bg: #721c24; --error-text: #f8d7da; --info-bg: #856404; --info-text: #fff3cd; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 500px; width: 100%; background-color: var(--container-bg); padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px var(--shadow-color); text-align: center; transition: background-color 0.3s; }
        h1 { margin-top: 0; margin-bottom: 1.5rem; }
        #reader { width: 100%; border-radius: 8px; overflow: hidden; border: 1px solid var(--input-border); }
        #result { margin-top: 1rem; padding: 1rem; border-radius: 8px; font-size: 1.1rem; font-weight: bold; min-height: 2.5rem; display: flex; align-items: center; justify-content: center; transition: background-color 0.3s, color 0.3s; }
        #scan-again-btn { margin-top: 1rem; width: 100%; padding: 0.75rem; background-color: var(--primary-btn-bg); color: white; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; transition: background-color 0.2s; }
        #scan-again-btn:hover { background-color: var(--primary-btn-hover); }
        .hidden { display: none; }
        .success { background-color: var(--success-bg); color: var(--success-text); }
        .error { background-color: var(--error-bg); color: var(--error-text); }
        .info { background-color: var(--info-bg); color: var(--info-text); }
        .theme-toggle-btn { position: absolute; top: 20px; right: 20px; background: var(--container-bg); border: 1px solid var(--input-border); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; justify-content: center; align-items: center; z-index: 10; font-size: 20px; line-height: 1; padding: 0; }
    </style>
</head>
<body>
    <button id="theme-toggle" class="theme-toggle-btn" title="Toggle theme"><span id="theme-icon"></span></button>
    <div class="container">
        <h1>QR Code Scanner</h1>
        <div id="reader"></div>
        <div id="result">Initializing Scanner...</div>
        <button id="scan-again-btn" class="hidden">Scan Again</button>
    </div>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script>
        const resultContainer = document.getElementById('result');
        const scanAgainBtn = document.getElementById('scan-again-btn');
        let html5QrcodeScanner;
        function startScanner() { html5QrcodeScanner.render(onScanSuccess, onScanFailure); }
        async function onScanSuccess(decodedText, decodedResult) {
            html5QrcodeScanner.clear();
            scanAgainBtn.classList.remove('hidden');
            try {
                const response = await fetch('/api/checkin', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token: decodedText }) });
                const data = await response.json();
                if (response.ok) {
                    resultContainer.textContent = data.message;
                    resultContainer.className = 'result ' + (data.message.includes('already') ? 'info' : 'success');
                } else { throw new Error(data.error || 'Check-in failed.'); }
            } catch (error) {
                resultContainer.textContent = `Error: ${error.message}`;
                resultContainer.className = 'result error';
            }
        }
        function onScanFailure(error) {}
        scanAgainBtn.addEventListener('click', () => {
            scanAgainBtn.classList.add('hidden');
            resultContainer.textContent = 'Scanning...';
            resultContainer.className = 'result';
            startScanner();
        });
        document.addEventListener('DOMContentLoaded', (event) => {
            html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: { width: 250, height: 250 } }, false);
            startScanner();
        });

        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const applyTheme = (theme) => {
            if (theme === 'dark') { document.body.classList.add('dark-theme'); themeIcon.textContent = '☀️'; } 
            else { document.body.classList.remove('dark-theme'); themeIcon.textContent = '🌙'; }
        };
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);
        themeToggleBtn.addEventListener('click', () => {
            const newTheme = document.body.classList.contains('dark-theme') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });
    </script>
</body>
</html>